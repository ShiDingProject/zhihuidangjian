<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>党员管理</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" media="screen" href="assets/css/index.css"/>
    <style>
        .avatar-uploader .el-upload {
            border: 1px dashed #d9d9d9;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .avatar-uploader .el-upload:hover {
            border-color: #409EFF;
        }
        .avatar-uploader-icon {
            font-size: 28px;
            color: #8c939d;
            width: 178px;
            height: 178px;
            line-height: 178px;
            text-align: center;
        }
        .avatar {
            width: 178px;
            height: 178px;
            display: block;
        }
        .titleimg{
            width: 50px;
            height: 50px;
            background: #000;
            border-radius: 50%;
        }
        .memberDetail{
            box-sizing: border-box;
            padding: 0px 100px;
            text-align: center;
        }
        .el-col p{
            text-align: left;
        }
        .city input{
            border: none;
        }
    </style>
</head>
<body>
    <div id="main">
        <template>
            <v-container href_now="3-2" :breadcrumb="breadcrumb">
                <div class="inner-title">
                    <span class="inner-title-span">党员列表</span>
                    <div class="wid-top-btnBox">
                        <el-button @click="dialogOpen">添加党员</el-button>
                    </div>
                </div>
                <div class="page-content">
                    <el-row :gutter="20">
                        <el-col :span="4">
                            <div class="nav-left" :style="{height:dom_height + 'px'}">
                                <el-tree :data="OrganizationList" :props="defaultProps" node-key="id" default-expand-all :expand-on-click-node="false">
                                    <span class="custom-tree-node" slot-scope="{ node, data }" @click="getPartymembersList(1,data.id)">
                                        <span>{{data.organization_name}}</span>
                                    </span>
                                </el-tree>
                            </div>
                        </el-col>
                        <el-col :span="20">
                            <el-form :model="search_form" :inline="true">
                                <el-form-item label="姓名查询：">
                                    <el-input v-model="search_form.name" placeholder="请输入内容"></el-input>
                                </el-form-item>
                                <el-form-item>
                                    <el-button size="small" type="primary" @click="queryList" >查询</el-button>
                                </el-form-item>
                                <el-form-item>
                                    <el-button size="small" @click="reset">重置</el-button>
                                </el-form-item>
                            </el-form>
                            <el-table :data="tableData" style="margin-bottom: 28px;">
                                <el-table-column prop="user_name" label="姓名"></el-table-column>
                                <el-table-column prop="organization_name" label="所属组织"></el-table-column>
                                <el-table-column prop="partyMember.party_state" label="党员状态" :formatter="state"></el-table-column>
                                <el-table-column prop="user_tel" label="手机号"></el-table-column>
                                <el-table-column prop="user_sex" label="性别" :formatter="sex"></el-table-column>
                                <el-table-column prop="partyMember.party_duty" label="党内职务"></el-table-column>
                                <el-table-column prop="user_integral" label="积分"></el-table-column>
                                <el-table-column width="320" label="操作">
                                    <template slot-scope="scope">
                                        <el-button size="mini" @click="frozenPartyMember(scope.row.id,1)" v-if="scope.row.user_isfrozen ? false : true">冻结</el-button>
                                        <el-button size="mini" @click="frozenPartyMember(scope.row.id,0)" v-if="scope.row.user_isfrozen ? true : false">解冻</el-button>
                                        <el-button size="mini" type="info" @click="editorInfo(scope.row.partyMember)">编辑</el-button>
                                        <el-button size="mini"  style="background: #2a3345;color: #fff;" @click="memberDetailFn(scope.row)">详情</el-button>
                                        <el-button size="mini" type="danger" @click="deletePartyMember(scope.row.id)">删除</el-button>
                                    </template>
                                </el-table-column>
                            </el-table>
                            <el-pagination background @current-change="handleCurrentChange" :current-page.sync="currentPage" :page-count="pagetotal" :page-size="pagesize" layout="prev, pager, next, jumper"></el-pagination>
                        </el-col>
                    </el-row>
                </div>
            </v-container>

            <el-dialog title="添加党员" :visible.sync="dialogFormVisible" width="50%" style="min-width: 800px;" top="80px" :show-close="false" :close-on-click-modal="false" :close-on-press-escape="false">
                <el-form :model="dialog_form" ref="dialog_form" label-width="110px">
                    <el-tag>基本信息</el-tag>
                    <el-form-item label="姓名：" prop="name" :rules="{required:true,message:'请填写姓名',trigger:'blur'}">
                        <el-input v-model="dialog_form.name" auto-complete="on" placeholder="请输入党员姓名"></el-input>
                    </el-form-item>
                    <el-form-item label="性别：" prop="gender" :rules="{required:true,message:'请选择性别',trigger:'change'}">
                        <el-select v-model="dialog_form.gender" placeholder="请选择">
                            <el-option v-for="item in gender_opt" :key="item.value" :label="item.label" :value="item.value"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="出生日期：" prop="birthday" :rules="{required:true,message:'请选择出生日期',trigger:'blur'}">
                        <el-date-picker v-model="dialog_form.birthday" type="date" placeholder="选择日期"></el-date-picker>
                    </el-form-item>
                    <el-form-item label="身份证号：" prop="id" :rules="[{required:true,message:'请填写身份证号',trigger:'blur'},{pattern: /(^[1-9]\d{5}(18|19|([23]\d))\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$)|(^[1-9]\d{5}\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{2}$)/, message: '证件号码格式有误！', trigger: 'blur'}]">
                        <el-input v-model="dialog_form.id" auto-complete="on" placeholder="请输入身份证号"></el-input>
                    </el-form-item>
                    <el-form-item label="城市：" prop="city" :rules="{required:true,message:'请选择城市',trigger:'change'}"> 
                        <el-cascader expand-trigger="hover" :props="props" :options="city_opt" v-model="dialog_form.city"></el-cascader>  
                    </el-form-item>
                    <el-form-item label="手机号：" prop="phone" :rules="[{required:true,message:'请填手机号码',trigger:'blur'},{pattern: /^1[3|4|5|7|8][0-9]\d{8}$/, message: '手机号码格式有误！', trigger: 'blur'}]">
                        <el-input v-model="dialog_form.phone" auto-complete="on" placeholder="请输入手机号码"></el-input>
                    </el-form-item>    
                </el-form>
                <div slot="footer" class="dialog-footer">
                    <el-button @click="dialogOff('dialog_form')">取 消</el-button>
                    <el-button type="primary" @click="submitDialogForm" :disabled="disabledBtn">确 定</el-button>
                </div>
            </el-dialog>

            <el-dialog :title="dialogTitle" :visible.sync="dialogFormVisible1" width="50%" style="min-width: 800px;" top="80px" :show-close="false" :close-on-click-modal="false" :close-on-press-escape="false">
                <el-form :model="dialog_form1" ref="dialog_form1" label-width="150px">
                    <el-tag>党员信息</el-tag>
                    <el-form-item label="照片：" :rules="{required:true,message:'请上传图片',trigger:'change'}">
                        <el-upload class="upload-demo" multiple :limit="1" :file-list="dialog_form1.fileList" action="#" :auto-upload="false" ref="upload" list-type="picture">
                            <el-button size="small" type="primary">点击选择图片</el-button>
                            <div slot="tip" class="el-upload__tip">请选择 1 张一寸照片只能上传jpg/png文件，且不超过500kb</div>
                        </el-upload>
                    </el-form-item>
                    <el-form-item label="所属组织：" prop="organize" :rules="{required:true,message:'请选择所属组织',trigger:'change'}">
                        <el-select v-model="dialog_form1.organize" placeholder="请选择所属组织">
                            <el-option v-for="item in organize_opt" :key="item.id" :label="item.organization_name" :value="item.id"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="申请入党时间：" prop="apply_date" :rules="{required:true,message:'请选择申请入党时间',trigger:'change'}">
                        <el-date-picker v-model="dialog_form1.apply_date" type="date" placeholder="选择日期" value-format="timestamp"></el-date-picker>
                    </el-form-item>
                    <el-form-item label="党员状态：" prop="status" :rules="{required:true,message:'请选择党员状态',trigger:'change'}">
                        <el-select v-model="dialog_form1.status" placeholder="请选择" @change="setpartyName">
                            <el-option v-for="item in status_opt" :key="item.value" :label="item.label" :value="item.value"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="正式入党时间：" prop="join_date">
                        <el-date-picker v-model="dialog_form1.join_date" type="date" placeholder="选择日期" value-format="timestamp"></el-date-picker>
                    </el-form-item>
                    <el-form-item label="所属职务：" prop="duty" :rules="{required:true,message:'请填写所属职务',trigger:'blur'}">
                        <el-input v-model="dialog_form1.duty" auto-complete="on" placeholder="如没有职务填“无”"></el-input>
                    </el-form-item>
                    <el-form-item label="毕业院校：" prop="graduated" :rules="{required:true,message:'请填写毕业院校',trigger:'blur'}">
                        <el-input v-model="dialog_form1.graduated" auto-complete="on" placeholder="毕业院校"></el-input>
                    </el-form-item>
                    <el-form-item label="学历：" prop="education" :rules="{required:true,message:'请选择学历',trigger:'change'}">
                        <el-select v-model="dialog_form1.education" placeholder="请选择">
                            <el-option v-for="item in education_opt" :key="item.value" :label="item.label" :value="item.value"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="专业：" prop="major">
                        <el-input v-model="dialog_form1.major" auto-complete="on" placeholder="专业"></el-input>
                    </el-form-item>
                    <el-form-item label="籍贯：" prop="native_place" :rules="{required:true,message:'请填写籍贯',trigger:'blur'}">
                        <el-input v-model="dialog_form1.native_place" auto-complete="on" placeholder="籍贯"></el-input>
                    </el-form-item>
                    <el-form-item label="微信号：" prop="wx">
                        <el-input v-model="dialog_form1.wx" auto-complete="on" placeholder="微信号"></el-input>
                    </el-form-item>
                    <el-form-item label="QQ号：" prop="qq">
                        <el-input v-model="dialog_form1.qq" auto-complete="on" placeholder="QQ号"></el-input>
                    </el-form-item>
                </el-form>
                <div slot="footer" class="dialog-footer">
                    <el-button @click="dialogOff('dialog_form1')">取 消</el-button>
                    <el-button type="primary" @click="submitDialogForm1" :disabled="disabledBtn">确 定</el-button>
                </div>
            </el-dialog>

            <!-- 党员详情 -->
            <el-dialog :visible.sync="memberDetail" width="50%" style="min-width: 800px;" top="80px" :close-on-click-modal="false" :close-on-press-escape="false">
                <div class="memberDetail">
                    <img :src="memberDetailData.user_picture" class="titleimg">
                    <p>{{memberDetailData.user_name}}</p>
                    <P>北城社区居委会</P>
                    <p>申请入党时间：{{partyMemberData.party_apply_time}}</p>
                    <p>正式入党时间：{{partyMemberData.party_join_time}}</p> 
                    <el-row>
                        <el-col :span="12"><p>出生日期：{{memberDetailData.user_birthday}}</p></el-col>
                        <el-col :span="12"><p>党员状态：{{partyMemberData.party_state|partyState}}</p></el-col>
                    </el-row>
                    <el-row>
                        <el-col :span="12"><p>身份证号：{{memberDetailData.user_idcard}}</p></el-col>
                        <el-col :span="12"><p>所属职务：{{partyMemberData.party_duty}}</p></el-col>
                    </el-row>
                    <el-row>
                        <el-col :span="12"><p>性别：{{memberDetailData.user_sex|userSex}}</p></el-col>
                        <el-col :span="12"><p>微信号：{{partyMemberData.party_wechat}}</p></el-col>
                    </el-row>
                    <el-row>
                        <el-col :span="12"><p>毕业院校：{{memberDetailData.party_graduated}}</p></el-col>
                        <el-col :span="12"><p>QQ号：{{partyMemberData.party_qq}}</p></el-col>
                    </el-row>
                    <el-row>
                        <el-col :span="12"><p>学历：{{partyMemberData.party_education|partyEducation}}</p></el-col>
                        <el-col :span="12"></el-col>
                    </el-row>
                    <el-row>
                        <el-col :span="12"><p>专业:{{partyMemberData.party_major}}</p></el-col>
                        <el-col :span="12"></el-col>
                    </el-row>
                    <el-row>
                        <el-col :span="12"><p>籍贯：{{partyMemberData.party_native_place}}</p></el-col>
                        <el-col :span="12"></el-col>
                    </el-row>
                    <el-row>
                        <el-col :span="12"><p>手机号：{{memberDetailData.user_tel}}</p></el-col>
                        <el-col :span="12"></el-col>
                    </el-row>
                </div>
            </el-dialog>
        </template>
    </div>
    <script src="assets/js/vue.js"></script>
    <script src="assets/js/element.js"></script>
    <script src="assets/js/component/container.js"></script>
    <script src="assets/js/ckeditor/ckeditor.js"></script>
    <script src="assets/js/axios.min.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/mock.js"></script>
    <script>
        var vm = new Vue({
            el:'#main',
            data:{
                dialogTitle:'',
                breadcrumb:['党建','党员管理'],
                // 设置按钮不可用
                disabledBtn:false,
                dialogTableVisible: false,
                dialogFormVisible: false,
                dialogFormVisible1: false,
                // 左侧党组织列表
                OrganizationList: [],
                defaultProps: {
                    children: '_child',
                    label: 'organization_name'
                },
                // 党员列表
                tableData: [],
                // 当前页面
                currentPage: 1,
                pagesize: 10,
                pagetotal:0,
                // 组织 ID
                ganizationId: 0,
				search_form: {
					name: '',
				},
                // 添加党员信息是否显示
                partyInfo:false,
                // 提示添加 党员 预备党员 入党积极分子
                partyName:'',
                // 用户 ID
                uesrId:-1,
                // 党员 ID
                partyId: -1,
                // 党员详情
                memberDetail:false,
                // 党员详情接受展示数据
                memberDetailData:{},
                partyMemberData:{},
				dialog_form: {
                    name:'',
                    gender:'',
                    birthday:'',
                    id:'',
                    city:[],
                    phone:''
				},
                dialog_form1: {
                    fileList:[],

                    organize:'',
                    apply_date:'',
                    status:'',
                    join_date:'',
                    duty:'',
                    graduated:'',
                    major:'',
                    native_place:'',
                    wx:'',
                    qq:'',
                    education:''
				},
                dom_height:'',
                gender_opt: [{
                    value: 1,
                    label: '男'
                }, {
                    value: 2,
                    label: '女'
                }],
                // 城市列表
                city_opt: [],
                props: {
                    value: 'id',
                    children: '_child',
                    label: 'label'
                },
                organize_opt:[],
                status_opt:[
                    {
                        label:'正式党员',
                        value:'1'
                    },
                    {
                        label:'预备党员',
                        value:'2'
                    },
                    {
                        label:'入党积极分子',
                        value:'3'
                    }
                ],
                education_opt:[
                    {
                        label:'其他',
                        value:'0',
                    },
                    {
                        label:'小学',
                        value:'1'
                    },
                    {
                        label:'初中',
                        value:'2'
                    },
                    {
                        label:'高中',
                        value:'3'
                    },
                    {
                        label:'中专',
                        value:'4'
                    },
                    {
                        label:'大专',
                        value:'5'
                    },
                    {
                        label:'本科',
                        value:'6'
                    },
                    {
                        label:'研究生',
                        value:'7'
                    },
                    {
                        label:'硕士',
                        value:'8'
                    },
                    {
                        label:'博士',
                        value:'9'
                    },
                ]
            },
            created:function(){
                var that = this;
                that.getOrganizationList();
                that.getPartymembersList(1,''); 
                that.getCityList();
            },
            mounted:function(){
                var that = this;
                var scrollHeight = document.getElementsByClassName('el-main')[0].scrollHeight;
                var clientHeight = document.getElementsByClassName('el-main')[0].clientHeight;
                console.log('clientHeight',clientHeight);
                console.log('scrollHeight',scrollHeight);
                if (clientHeight < scrollHeight) {
                    that.dom_height = scrollHeight + 60;
                }else{
                    that.dom_height = clientHeight - 100;
                }
            },
            filters:{
                partyState:function(value){
                    switch(value){
                        case 1:
                            return '正式党员';
                            break;
                        case 2:
                            return '预备党员';
                            break;
                        case 3:
                            return '入党积极分子';
                            break;
                    };
                },
                userSex:function(value){
                    switch(value){
                        case 1:
                            return '男';
                            break;
                        case 2:
                            return '女';
                            break;
                    };
                },
                partyEducation:function(value){
                    switch(value){
                        case 0:
                            return '其他';
                            break;
                        case 1:
                            return '小学';
                            break;  
                        case 2:
                            return '初中';
                            break;
                        case 3:
                            return '高中';
                            break;
                        case 4:
                            return '中专';
                            break;
                        case 5:
                            return '大专';
                            break;
                        case 6:
                            return '本科';
                            break;
                        case 7:
                            return '研究生';
                            break;
                        case 8:
                            return '硕士';
                            break;
                        case 9:
                            return '博士';
                            break;
                    };
                }
            },
            methods:{   

                // 编辑
                editorInfo:function(data){
                    var that = this;
                    that.dialogTitle = '编辑党员信息';
                    that.partyId = data.id;
                    that.uesrId = data.user_id;
                    var dialog_form1 = that.dialog_form1;
                    api.post('/admin/OrganizationStructures/noTreeList',{},function(res){
                        if (res.data.code == 1005) {
                            that.organize_opt = res.data.data;
                            dialog_form1.organize = data.party_organization_id;
                        }
                    },function(err){
                        console.log(err);
                    });
                    dialog_form1.apply_date = new Date(data.party_apply_time);
                    dialog_form1.status = data.party_state.toString();
                    that.setpartyName(data.party_state);
                    dialog_form1.join_date = new Date(data.party_join_time);
                    dialog_form1.duty = data.party_duty;
                    dialog_form1.graduated = data.party_graduated;
                    dialog_form1.major = data.party_major !== "null " ? data.party_major : '';
                    dialog_form1.native_place = data.party_native_place;
                    dialog_form1.wx = data.party_wechat !== "null " ? data.party_wechat : '';
                    dialog_form1.qq = data.party_qq !== "null " ? data.party_qq : '';
                    dialog_form1.education = data.party_education.toString();
                    that.$nextTick(function(){
                        var url = [{name:'upload-img',url:data.party_picture}];
                        dialog_form1.fileList = url;
                    });
                    that.dialogFormVisible1 = true;
                },

                //冻结党员
                frozenPartyMember:function(id,frozen){
                    var that = this;
                    var name = '';
                    if(frozen === 1){
                        name = '冻结';
                    }else{
                        name = '解冻';
                    };
                    that.$confirm('此操作将'+name+'该党员, 是否继续?', '提示', {confirmButtonText: '确定',cancelButtonText: '取消',type: 'warning'
                    }).then(function(){
                        api.post('/admin/partymembers/frozen',
                        {
                            'user_id': id,
                            'frozen':frozen
                        },function(res){
                            if(res.data.code === 2005){
                                that.$message({type: 'success',message: '冻结成功!'});
                                that.getPartymembersList(that.currentPage,that.ganizationId);
                            }else if(res.data.code === 2007){
                                that.$message({type: 'success',message: res.data.msg});
                                that.getPartymembersList(that.currentPage,that.ganizationId);
                            }
                        },function(err){
                            that.$message({type: 'warning',message: err.msg});
                        });
                        
                    }).catch(function(){
                        that.$message({type: 'info',message: '取消冻结'});
                    });
                },

                // 党员详情
                memberDetailFn:function(data){
                    var that = this;
                    that.memberDetail = true;
                    that.memberDetailData = data;
                    that.partyMemberData = that.memberDetailData.partyMember;
                    console.log(data);
                },

                // 查询
                queryList:function(){
                    var that = this;
                    api.post('/admin/partymembers/list',
                    {
                        num: 10,
                        page:1,
                        organization_id:that.ganizationId,
                        user_name:that.search_form.name
                    },function(res){
                        that.tableData = res.data.data.data;
                    },function(err){
                        console.log(err);
                    });
                },
                reset:function(){
                    var that = this;
                    that.getPartymembersList(1,''); 
                    that.search_form.name = '';
                },

                // 正式入党时间不能早于申请入党时间
                validatePass:function(rule, value, callback){
                    if (this.dialog_form1.apply_date === '') {
                        callback(new Error('请先输入申请入党时间'));
                        this.dialog_form1.join_date = '';
                    }else{
                        if(value === ''){
                            callback(new Error('请输入正式入党时间'));
                        }else if(this.dialog_form1.apply_date > value){ 
                            callback(new Error('正式入党时间不能早于申请入党时间'));
                        }else{
                            callback();
                        };
                    };
                },

                // 获取组织
                getSuperiorList:function(){
                    var that = this;
                    api.post('/admin/OrganizationStructures/noTreeList',{},function(res){
                        that.organize_opt = res.data.data;
                    },function(err){
                        that.$message({type: 'warning',message: err.message});
                    });
                },

                // 获取时间格式 YYYY-MM-DD
                gettime:function(date) {
                    var seperator1 = "-";
                    var year = date.getFullYear();
                    var month = date.getMonth() + 1;
                    var strDate = date.getDate();
                    if (month >= 1 && month <= 9) {
                        month = "0" + month;
                    }
                    if (strDate >= 0 && strDate <= 9) {
                        strDate = "0" + strDate;
                    }
                    var currentdate = year + seperator1 + month + seperator1 + strDate;
                    return currentdate;
                },

                // 添加用户
                addUser:function(){
                    var that = this;
                    var data = that.dialog_form;   
                    var date = that.gettime(data.birthday);
                    api.post('/admin/users/addEdit', 
                    {
                        user_name:data.name,
                        user_birthday:date,
                        user_tel:data.phone,
                        user_sex:data.gender,
                        user_province:data.city[0],
                        user_city:data.city[1],
                        user_idcard:data.id
                    },function(res){
                        if (res.data.code == 1001) {
                            that.partyInfo = true;
                            that.uesrId = res.data.data.id;
                            that.dialogFormVisible1 = true;
                            that.disabledBtn = false;
                            that.dialogOff('dialog_form');
                        }else{
                            that.$message({type: 'warning',message: res.data.msg});
                            that.disabledBtn = false;
                        }
                    },function(err){
                        that.$message({type: 'warning',message: err.message});
                        that.disabledBtn = false;
                    });
                },
                setpartyName:function(value){
                    var that = this;
                    switch(value){
                        case 1:
                            that.partyName = '正式党员';
                            break;
                        case 2:
                            that.partyName = '预备党员';
                            break;
                        case 3:
                            that.partyName = '入党积极分子';
                            break;
                    };
                },
                // 添加党员
                addPartyMember:function(data){
                    var that = this;
                    console.log(data);
                    var apply_date = data.apply_date+'';
                    var join_date = data.join_date+'';
                    apply_date = parseInt(apply_date.slice(0,10));
                    join_date = parseInt(join_date.slice(0,10));
                    var formdata = new FormData();
                    if(data.fileList[0].raw !== undefined){
                        formdata.append('thumb',data.fileList[0].raw);
                    };
                    formdata.append('user_id',that.uesrId);
                    formdata.append('party_wechat',data.wx);
                    formdata.append('party_qq',data.qq);
                    formdata.append('party_education',data.education);
                    formdata.append('party_graduated',data.graduated);
                    formdata.append('party_major',data.major);
                    formdata.append('party_native_place',data.native_place);
                    formdata.append('party_organization_id',data.organize);
                    formdata.append('party_duty',data.duty);
                    formdata.append('party_state',data.status);
                    formdata.append('party_apply_time',apply_date);
                    formdata.append('party_join_time',join_date);
                    if(that.partyId > 0){
                        formdata.append('id',that.partyId);
                    }
                    api.post('/admin/partymembers/addEdit',formdata,function(res){
                        if (res.data.code == 1001) {
                            that.uesrId = -1;
                            that.partyId = -1;
                            that.getPartymembersList(that.currentPage,that.ganizationId);
                            that.disabledBtn = false;
                            that.dialogOff('dialog_form1');
                        }else{
                            that.$message({type: 'warning',message: res.data.msg});
                            that.disabledBtn = false;
                        }
                    },function(err){
                        that.$message({type: 'warning',message: err.message});
                        that.disabledBtn = false;
                    });
                },

                // 删除党员
                deletePartyMember:function(id){
                    var that = this;
                    this.$confirm('此操作将永久删除该党员, 是否继续?', '提示', {confirmButtonText: '确定',cancelButtonText: '取消',type: 'warning'
                    }).then(function(){
                        api.post('/admin/partymembers/destroy',{
                            id:id
                        },function(res){
                            console.log(res);
                            if(res.data.code === 1003){

                                that.$message({type: 'success',message: '删除成功!'});
                                that.getPartymembersList(that.currentPage,that.ganizationId);
                            }else{
                                that.$message({type: 'warning',message: res.data.msg});
                            }
                        },function(err){
                            that.$message({type: 'warning',message: err.message});
                        });
                        
                    }).catch(function(){
                        that.$message({type: 'info',message: '已取消删除'});
                    });
                },

                // 请求组织列表
                getOrganizationList:function(){
                    var that = this;
                    api.post('/admin/OrganizationStructures/list',{},function(res){
                        if (res.data.code == 1005) {
                            console.log(res.data.data);
                            that.OrganizationList = res.data.data;
                        }else{
                            that.$message({type: 'warning',message: res.data.msg});
                        }
                    },function(err){
                        that.$message({type: 'warning',message: err.message});
                    });
                },

                // 请求党员列表
                getPartymembersList:function(currentPage,organization_id){
                    var that = this;
                    that.ganizationId = organization_id;
                    api.post('/admin/partymembers/list',
                    {
                        num: that.pagesize,
                        page:currentPage,
                        organization_id:organization_id
                    },function(res){
                        if (res.data.code == 1005) {
                            console.log(res.data.data.data);
                            that.tableData = res.data.data.data;
                            that.pagetotal = res.data.data.last_page;
                        }else{
                            that.$message({type: 'warning',message: res.data.msg});
                        }
                        
                    },function(err){
                        that.$message({type: 'warning',message: err.message});
                    });
                },
                // 请求城市列表
                getCityList:function(){
                    var that = this;
                    api.post('/admin/users/getRegionWorld',{},function(res){
                        if (res.data.code == 1005) {
                            that.city_opt = res.data.data[239]._child;
                        }else{
                            that.$message({type: 'warning',message: res.data.msg});
                        }
                    },function(err){
                        that.$message({type: 'warning',message: err.message});
                    });
                },
                handleCurrentChange:function(val) {
                    var that = this;
                    that.currentPage = val;
                    that.getPartymembersList(val,that.ganizationId);
                },
        
                dialogOpen:function(){
                    var that = this;
                    that.dialogFormVisible = true;
                    that.dialogTitle = '添加党员';
                    that.getSuperiorList();
                },
                dialogOff:function(type){
                    var that = this;
                    console.log(type);
                    if(type === 'dialog_form1'){
                        that.$refs['dialog_form1'].resetFields();
                        that.dialogFormVisible1 = false;
                        that.dialog_form1 = {
                            fileList:[],
                            organize:'',
                            apply_date:'',
                            status:'',
                            join_date:'',
                            duty:'',
                            graduated:'',
                            major:'',
                            native_place:'',
                            wx:'',
                            qq:'',
                            education:''
                        };
                    }else if(type === 'dialog_form'){
                        that.$refs['dialog_form'].resetFields();
                        that.dialogFormVisible = false;
                        that.dialog_form = {
                            name:'',
                            gender:'',
                            birthday:'',
                            id:'',
                            city:[],
                            phone:''
                        };
                    }
                },
                // 提交 表单
                submitDialogForm:function(){
                    var that = this;
                    that.$refs.dialog_form.validate(function(valid){
                        if (valid) {
                            that.disabledBtn = true;
                            that.addUser();
                        }
                    });
                },
                submitDialogForm1:function(){
                    var that = this;
                    that.$refs.dialog_form1.validate(function(valid){
                        if (valid) {
                            if(that.$refs.upload){
                                that.$confirm('此操作将升级'+that.partyName+', 是否继续?', '提示', {
                                    confirmButtonText: '确定',
                                    cancelButtonText: '取消',
                                    type: 'warning'
                                }).then(function(){
                                    that.disabledBtn = true;
                                    that.dialog_form1.fileList = that.$refs.upload.uploadFiles;
                                    that.addPartyMember(that.dialog_form1);
                                }).catch(function(){
                                    that.$message({
                                        type: 'info',
                                        message: '已取消升级党员'
                                    });          
                                });
                            };
                        }
                    });
                },
                // 筛选展示男女
                sex:function(row){
                    switch(row.user_sex){
                        case 1:
                            return '男';
                            break;
                        case 2:
                            return '女';
                            break;
                    };
                },

                state:function(row){
                    switch(row.partyMember.party_state){
                        case 1:
                            return '正式党员';
                            break;
                        case 2:
                            return '预备党员';
                            break;
                        case 3:
                            return '入党积极分子';
                            break;
                    };
                },
            }
        });
    </script>
</body>
</html>